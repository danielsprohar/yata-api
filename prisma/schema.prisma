generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgcrypto]
}

model User {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @map("user_id") @db.Uuid
  email              String    @unique
  emailVerified      Boolean   @default(false) @map("email_verified")
  password           String?
  googleId           String?   @map("google_id")
  name               String?
  phoneNumber        String?   @map("phone_number")
  phoneVerified      Boolean   @default(false) @map("phone_verified")
  picture            String?
  tenant             String?
  username           String?
  nickname           String?
  familyName         String?   @map("family_name")
  givenName          String?   @map("given_name")
  blocked            Boolean   @default(false)
  blockedFor         String?   @map("blocked_for")
  lastIp             String?   @map("last_ip")
  multifactor        String?
  multifactorUpdated DateTime? @map("multifactor_updated")
  lastLogin          DateTime? @map("last_login") @db.Timestamptz(6)
  lastPasswordReset  DateTime? @map("last_password_reset") @db.Timestamptz(6)
  loginsCount        Int       @default(1) @map("logins_count")
  preferences        Json?
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)
  projects           Project[]
  tags               Tag[]
  tasks              Task[]

  @@map("users")
}

model Project {
  id        Int         @id @default(autoincrement())
  name      String      @db.VarChar(64)
  important Boolean     @default(false)
  view      ProjectView @default(LIST) @map("view")
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime?   @updatedAt @map("updated_at") @db.Timestamptz(6)
  userId    String      @map("user_id") @db.Uuid
  User      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sections  Section[]
  tasks     Task[]

  @@index([id, userId])
  @@map("projects")
}

model Task {
  id          Int       @id @default(autoincrement())
  title       String    @db.VarChar(4096)
  description String?
  content     String?
  priority    Int?      @default(0)
  order       Int       @default(0) @map("order")
  isDeleted   Boolean   @default(false) @map("is_deleted")
  isCompleted Boolean   @default(false) @map("is_completed")
  isAllDay    Boolean   @default(true) @map("is_all_day")
  dueDate     DateTime? @map("due_date") @db.Timestamptz(6)
  startDate   DateTime? @map("start_date") @db.Timestamptz(6)
  rruleSet    String?   @map("rrule_set") @db.VarChar(1024)
  rrule       String?   @map("rrule") @db.VarChar(1024)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)
  projectId   Int       @map("project_id")
  sectionId   Int?      @map("section_id")
  userId      String    @map("user_id") @db.Uuid
  parentId    Int?      @map("parent_id")
  task        Task?     @relation("subtasks", fields: [parentId], references: [id])
  subtasks    Task[]    @relation("subtasks")
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  section     Section?  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags        Tag[]     @relation("TagToTask")

  @@index([id, userId])
  @@index([title])
  @@map("tasks")
}

model Section {
  id        Int     @id @default(autoincrement())
  name      String  @db.VarChar(64)
  order     Int     @default(0)
  projectId Int     @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@map("sections")
}

model Tag {
  id           Int     @id @default(autoincrement())
  name         String  @db.VarChar(32)
  colorHexCode String? @db.VarChar(8)
  userId       String  @map("user_id") @db.Uuid
  User         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks        Task[]  @relation("TagToTask")

  @@unique([name, userId])
  @@map("tags")
}

enum ProjectView {
  LIST
  KANBAN

  @@map("project_view")
}
